<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astro Jyotish Prediction</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#1d4ed8" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f3f4f6; }
    .container { max-width: 600px; margin: auto; padding: 20px; background-color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); border-radius: 10px; }
    h1 { text-align: center; color: #1d4ed8; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { padding: 8px; width: 100%; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    button { margin-top: 20px; width: 100%; padding: 12px; font-size: 16px; background-color: #1d4ed8; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #2563eb; }
    #result { margin-top: 20px; font-size: 16px; white-space: pre-line; }
    #chart img, #chart svg { margin-top: 20px; width: 100%; border: 1px solid #ccc; border-radius: 8px; }
    #downloadPdfBtn { margin-top: 20px; background-color: #10b981; }
    #downloadPdfBtn:hover { background-color: #059669; }
    .footer { margin-top: 30px; text-align: center; color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Get Your Jyotish Prediction</h1>
    <label for="name">Name:</label>
    <input type="text" id="name" />
    <label for="dob">Date of Birth:</label>
    <input type="date" id="dob" />
    <label for="time">Time of Birth (HH:MM):</label>
    <input type="time" id="time" />
    <label for="location">Location (City, State, Country):</label>
    <input type="text" id="location" />
    <label for="language">Language:</label>
    <select id="language">
      <option value="english">English</option>
      <option value="hindi">Hindi</option>
    </select>
    <button onclick="getPrediction()">Get Prediction</button>
    <div id="chart"></div>
    <div id="result">Your prediction will appear here...</div>
    <button id="downloadPdfBtn" style="display: none" onclick="downloadPdf()">Download Your Jyotish Predictions</button>
    <div class="footer">Service provided by Palmology</div>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }

    async function getPrediction() {
      const dob = document.getElementById('dob').value;
      const [year, month, day] = dob.split('-').map(Number);
      const time = document.getElementById('time').value;
      const [hour, minute] = time.split(':').map(Number);
      const location = document.getElementById('location').value;
      const geoResponse = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(location)}&key=15459e2a83eb42de9cd2b77a168c9307`);
      const geoData = await geoResponse.json();
      const { lat, lng } = geoData.results[0].geometry;
      const timezone = geoData.results[0].annotations.timezone.offset_sec / 3600;
      const data = {
        name: document.getElementById('name').value, day, month, year, hour, minute,
        latitude: lat, longitude: lng, timezone, language: document.getElementById('language').value
      };
      document.getElementById('result').innerText = 'Generating prediction...';
      document.getElementById('chart').innerHTML = '';
      document.getElementById('downloadPdfBtn').style.display = 'none';
      try {
        const response = await fetch('/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await response.json();
        if (result.prediction) {
          document.getElementById('result').innerText = result.prediction;
          if (result.chartSvg) {
            document.getElementById('chart').innerHTML = `<h3>Your Horoscope Chart (D1)</h3><div id="svgContainer">${result.chartSvg}</div>`;
          }
          document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        } else {
          document.getElementById('result').innerText = 'Prediction failed. Try again.';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('result').innerText = 'Error: Unable to get prediction.';
      }
    }
    function downloadPdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById('name').value;
      const prediction = document.getElementById('result').innerText;
      const lines = doc.splitTextToSize(prediction, 180);
      let y = 20;
      doc.text(`Jyotish Prediction for ${name}`, 10, 10);
      lines.forEach(line => { if (y > 250) { doc.addPage(); y = 20; } doc.text(line, 10, y); y += 7; });
      const svgElement = document.querySelector('#svgContainer svg');
      if (svgElement) {
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const canvas = document.createElement('canvas');
        const svgSize = svgElement.getBoundingClientRect();
        canvas.width = svgSize.width; canvas.height = svgSize.height;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = function () {
          ctx.drawImage(img, 0, 0);
          URL.revokeObjectURL(url);
          const imgData = canvas.toDataURL('image/png');
          doc.addPage(); doc.addImage(imgData, 'PNG', 10, 10, 180, 180);
          doc.save(`${name.replace(/\s+/g, '_')}_jyotish_prediction.pdf`);
        };
        img.src = url;
      } else {
        doc.save(`${name.replace(/\s+/g, '_')}_jyotish_prediction.pdf`);
      }
    }
  </script>
</body>
</html>