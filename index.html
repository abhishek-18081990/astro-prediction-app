<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Palmology Jyotish Dashboard</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0b1e3d" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Lottie for loading animation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js" integrity="sha512-..." crossorigin="anonymous"></script>

  <!-- tsparticles for background -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.9.3/tsparticles.bundle.min.js"></script>

  <style>
    /* Reset & base */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Montserrat',sans-serif; background:#0b1e3d; color:#eee; overflow-x:hidden; }
    a, button { font-family:inherit; }
    /* Full-screen particles bg */
    #tsparticles { position:fixed; inset:0; z-index:-1; }
    /* Auth & layout */
    .container { max-width:480px; margin:0 auto; padding:20px; }
    .hidden { display:none!important; }
    h1 { text-align:center; margin:20px 0; color:#ff6f61; }
    /* Buttons */
    .btn { display:inline-block; width:100%; padding:12px; border:none; border-radius:6px; font-size:1rem; cursor:pointer; margin-top:15px; }
    .btn-primary { background:#ff6f61; color:#fff; }
    .btn-primary:hover { background:#e65b51; }
    .btn-logout { background:#444; color:#fff; margin-top:10px; }
    /* Form */
    .form-group { margin-bottom:15px; }
    label { display:block; margin-bottom:6px; color:#ccc; }
    input, select { width:100%; padding:10px; border:none; border-radius:6px; background:#2e2e2e; color:#eee; }
    input:focus, select:focus { outline:2px solid #ff6f61; }
    /* Modal & tabs */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center; z-index:10; }
    .modal { background:#1e293b; border-radius:10px; width:90%; max-width:360px; max-height:80vh; overflow:hidden; }
    .tab-header { display:flex; overflow-x:auto; background:#111827; }
    .tab-header div { flex:1; padding:12px; text-align:center; cursor:pointer; white-space:nowrap; color:#ccc; }
    .tab-header .active { background:#ff6f61; color:#fff; }
    .tab-content { padding:15px; max-height:60vh; overflow-y:auto; }
    /* Loading */
    #loadingScreen { position:fixed; inset:0; background:#0b1e3d; display:flex; align-items:center; justify-content:center; z-index:20; }
    /* Footer */
    .footer { text-align:center; margin:30px 0 10px; color:#bbb; font-size:0.85rem; }
    /* Responsive */
    @media (max-width:480px) { .container { padding:15px; } h1 { font-size:1.5rem; } }
  </style>
</head>
<body>
  <!-- Particles Background -->
  <div id="tsparticles"></div>

  <!-- Loading Screen (6-10s) -->
  <div id="loadingScreen">
    <div id="lottieLoader" style="width:150px; height:150px;"></div>
  </div>

  <div class="container">
    <h1>Palmology Jyotish</h1>

    <!-- Authentication -->
    <div id="authPanel">
      <button class="btn btn-primary" id="googleSignInBtn">Sign in with Google</button>
    </div>
    <div id="userPanel" class="hidden">
      <p>Welcome, <span id="userName"></span></p>
      <button class="btn btn-logout" id="signOutBtn">Sign Out</button>
    </div>

    <!-- Birth Details Form -->
    <div id="formPanel" class="hidden">
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" placeholder="Your Name" />
      </div>
      <div class="form-group">
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob" />
      </div>
      <div class="form-group">
        <label for="time">Time of Birth</label>
        <input type="time" id="time" />
      </div>
      <div class="form-group">
        <label for="location">Location</label>
        <input type="text" id="location" placeholder="City, State, Country" />
      </div>
      <div class="form-group">
        <label for="language">Language</label>
        <select id="language">
          <option value="english">English</option>
          <option value="hindi">Hindi</option>
        </select>
      </div>
      <button class="btn btn-primary" id="submitBtn">Next</button>
    </div>

    <!-- Modal for D1 Chart & Prediction Tabs -->
    <div id="reportModal" class="hidden">
      <div class="modal-overlay">
        <div class="modal">
          <div class="tab-header">
            <div id="tabChart" class="active">D1 Chart</div>
            <div id="tabPrediction">Prediction</div>
          </div>
          <div class="tab-content" id="contentChart">
            <p>Loading chart...</p>
          </div>
          <div class="tab-content hidden" id="contentPrediction">
            <p>Loading prediction...</p>
          </div>
          <button class="btn btn-logout" id="closeModal">Close</button>
        </div>
      </div>
    </div>

  </div>
  <div class="footer">Service provided by Palmology</div>

  <script>
    // Initialize PWA service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js');
    }
    // Initialize tsParticles
    tsParticles.load('tsparticles', {
      fpsLimit:60,
      particles:{ number:{ value:80 }, color:{ value:['#ffffff','#ffff00'] }, shape:{ type:'star' }, opacity:{ value:0.6 }, size:{ value:{min:1,max:3} }, move:{ enable:true, speed:1.5 }
      }
    });
    // Lottie loading
    lottie.loadAnimation({ container: document.getElementById('lottieLoader'), renderer:'svg', loop:true, autoplay:true, path:'/animations/Animation-1745504213622.json' });
    // Hide loading after max 10s
    setTimeout(()=> document.getElementById('loadingScreen').remove(), 10000);

    // Firebase config (replace with your config)
    const firebaseConfig = { /* API_KEY, AUTH_DOMAIN, PROJECT_ID, ... */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elements
    const googleSignInBtn = document.getElementById('googleSignInBtn');
    const userPanel = document.getElementById('userPanel');
    const authPanel = document.getElementById('authPanel');
    const signOutBtn = document.getElementById('signOutBtn');
    const userNameSpan = document.getElementById('userName');
    const formPanel = document.getElementById('formPanel');
    const submitBtn = document.getElementById('submitBtn');
    const reportModal = document.getElementById('reportModal');
    const closeModal = document.getElementById('closeModal');
    const tabChart = document.getElementById('tabChart');
    const tabPrediction = document.getElementById('tabPrediction');
    const contentChart = document.getElementById('contentChart');
    const contentPrediction = document.getElementById('contentPrediction');

    // Auth flows
    googleSignInBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    signOutBtn.onclick = () => auth.signOut();
    auth.onAuthStateChanged(user => {
      if (user) {
        authPanel.classList.add('hidden'); userPanel.classList.remove('hidden'); userNameSpan.innerText = user.displayName;
        formPanel.classList.remove('hidden');
      } else {
        authPanel.classList.remove('hidden'); userPanel.classList.add('hidden'); formPanel.classList.add('hidden');
      }
    });

    // Submit and open modal
    submitBtn.onclick = async () => {
      // Optionally save to Firestore
      // await db.collection('profiles').doc(auth.currentUser.uid).set({ name, dob, time, ... });
      reportModal.classList.remove('hidden');
      loadChart();
      loadPrediction();
    };
    closeModal.onclick = () => reportModal.classList.add('hidden');

    // Tab switching
    tabChart.onclick = () => {
      tabChart.classList.add('active'); tabPrediction.classList.remove('active');
      contentChart.classList.remove('hidden'); contentPrediction.classList.add('hidden');
    };
    tabPrediction.onclick = () => {
      tabPrediction.classList.add('active'); tabChart.classList.remove('active');
      contentPrediction.classList.remove('hidden'); contentChart.classList.add('hidden');
    };

    // Fetch chart
    async function loadChart() {
      contentChart.innerHTML = '<p>Loading chart...</p>';
      try {
        const res = await fetch(window.location.origin + '/predict-chart', { method:'POST', body: JSON.stringify(collectForm()) });
        const data = await res.json();
        contentChart.innerHTML = data.svg ? data.svg : '<p>Failed to load chart.</p>';
      } catch { contentChart.innerHTML = '<p>Error loading chart.</p>'; }
    }
    // Fetch prediction
    async function loadPrediction() {
      contentPrediction.innerHTML = '<p>Loading prediction...</p>';
      try {
        const res = await fetch(window.location.origin + '/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(collectForm()) });
        const data = await res.json();
        contentPrediction.innerText = data.prediction || 'Prediction unavailable.';
      } catch { contentPrediction.innerHTML = '<p>Error loading prediction.</p>'; }
    }
    function collectForm() {
      const dob = document.getElementById('dob').value.split('-').map(Number);
      const time = document.getElementById('time').value.split(':').map(Number);
      return {
        name: document.getElementById('name').value,
        day:dob[2], month:dob[1], year:dob[0],
        hour:time[0], minute:time[1],
        location:document.getElementById('location').value,
        language:document.getElementById('language').value
      };
    }
  </script>
</body>
</html>
